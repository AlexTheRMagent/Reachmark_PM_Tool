generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  GUEST
}

enum PrivacyLevel {
  PRIVATE
  SHARED
}

enum EntityType {
  WORKSPACE
  SPACE
  FOLDER
  LIST
  TASK
  DOC
  DASHBOARD
  GOAL
}

enum TaskPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum ActivityAction {
  CREATE
  UPDATE
  DELETE
  COMMENT
  STATUS_CHANGE
  SHARE
  AUTOMATION_RUN
}

model User {
  id                String              @id @default(cuid())
  name              String?
  email             String?             @unique
  emailVerified     DateTime?
  image             String?
  passwordHash      String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  sessions          Session[]
  accounts          Account[]
  memberships       WorkspaceMember[]
  notifications     Notification[]
  notificationPrefs NotificationPref?
  comments          Comment[]
  taskAssignments   TaskAssignee[]
  teamMemberships   TeamMember[]
  activityLogs      ActivityLog[]
}

model Workspace {
  id          String              @id @default(cuid())
  name        String
  ownerId     String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  members     WorkspaceMember[]
  teams       Team[]
  spaces      Space[]
  docs        Doc[]
  goals       Goal[]
  dashboards  Dashboard[]
  automations AutomationRule[]
  customFields CustomField[]
  statuses    Status[]
  tasks       Task[]
  activity    ActivityLog[]
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(MEMBER)
  createdAt   DateTime      @default(now())
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
}

model Team {
  id          String       @id @default(cuid())
  workspaceId String
  name        String
  privacy     PrivacyLevel @default(SHARED)
  createdAt   DateTime     @default(now())
  workspace   Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members     TeamMember[]
}

model TeamMember {
  id      String @id @default(cuid())
  teamId  String
  userId  String
  team    Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}

model Space {
  id          String       @id @default(cuid())
  workspaceId String
  name        String
  privacy     PrivacyLevel @default(SHARED)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  workspace   Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  folders     Folder[]
  lists       List[]
  statuses    Status[]
}

model Folder {
  id        String       @id @default(cuid())
  spaceId    String
  name      String
  privacy   PrivacyLevel @default(SHARED)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  space     Space        @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  lists     List[]
}

model List {
  id        String       @id @default(cuid())
  spaceId   String
  folderId  String?
  name      String
  privacy   PrivacyLevel @default(SHARED)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  space     Space        @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  folder    Folder?      @relation(fields: [folderId], references: [id], onDelete: SetNull)
  tasks     TaskList[]
}

model Task {
  id            String         @id @default(cuid())
  customId      String         @unique
  workspaceId   String
  title         String
  description   String?
  priority      TaskPriority   @default(NORMAL)
  dueDate       DateTime?
  startDate     DateTime?
  completedAt   DateTime?
  createdById   String?
  parentTaskId  String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  statusId      String?
  workspace     Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  status        Status?        @relation(fields: [statusId], references: [id], onDelete: SetNull)
  taskLists     TaskList[]
  assignees     TaskAssignee[]
  comments      Comment[]
  attachments   Attachment[]
  customValues  TaskCustomFieldValue[]
  subtasks      Task[]         @relation("Subtasks")
  parentTask    Task?          @relation("Subtasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  dependenciesFrom TaskDependency[] @relation("DependencyFrom")
  dependenciesTo   TaskDependency[] @relation("DependencyTo")
}

model TaskList {
  id      String @id @default(cuid())
  taskId  String
  listId  String
  task    Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  list    List   @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([taskId, listId])
}

model TaskAssignee {
  id      String @id @default(cuid())
  taskId  String
  userId  String
  task    Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
}

model TaskDependency {
  id           String @id @default(cuid())
  blockingId   String
  blockedId    String
  createdAt    DateTime @default(now())
  blockingTask Task   @relation("DependencyFrom", fields: [blockingId], references: [id], onDelete: Cascade)
  blockedTask  Task   @relation("DependencyTo", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockingId, blockedId])
}

model CustomField {
  id          String    @id @default(cuid())
  workspaceId String
  name        String
  type        String
  options     Json?
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  values      TaskCustomFieldValue[]
}

model TaskCustomFieldValue {
  id            String      @id @default(cuid())
  taskId         String
  customFieldId  String
  value          String?
  task           Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  customField    CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([taskId, customFieldId])
}

model Status {
  id          String    @id @default(cuid())
  workspaceId String
  spaceId     String?
  name        String
  color       String
  createdAt   DateTime  @default(now())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  space       Space?    @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  tasks       Task[]
}

model Comment {
  id          String   @id @default(cuid())
  authorId    String
  taskId      String?
  docId       String?
  body        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  doc         Doc?     @relation(fields: [docId], references: [id], onDelete: Cascade)
}

model Attachment {
  id        String   @id @default(cuid())
  taskId    String
  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model Doc {
  id          String   @id @default(cuid())
  workspaceId String
  title       String
  content     String
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  comments    Comment[]
}

model Goal {
  id          String   @id @default(cuid())
  workspaceId String
  title       String
  description String?
  targetValue Float
  currentValue Float   @default(0)
  dueDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Dashboard {
  id          String   @id @default(cuid())
  workspaceId String
  title       String
  widgetsJson Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model AutomationRule {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  trigger     String
  condition   String
  action      String
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String
  payload     Json
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NotificationPref {
  id                 String   @id @default(cuid())
  userId             String   @unique
  notifyAssignments  Boolean  @default(true)
  notifyComments     Boolean  @default(true)
  notifyMentions     Boolean  @default(true)
  notifyStatus       Boolean  @default(true)
  notifyAutomation   Boolean  @default(true)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SharePermission {
  id           String        @id @default(cuid())
  entityType   EntityType
  entityId     String
  workspaceId  String
  userId       String?
  teamId       String?
  canView      Boolean       @default(true)
  canEdit      Boolean       @default(false)
  createdAt    DateTime      @default(now())
}

model ActivityLog {
  id           String        @id @default(cuid())
  workspaceId  String
  userId       String?
  entityType   EntityType
  entityId     String
  action       ActivityAction
  message      String
  metadata     Json?
  createdAt    DateTime      @default(now())
  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id            String   @id @default(cuid())
  sessionToken  String   @unique
  userId        String
  expires       DateTime
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
